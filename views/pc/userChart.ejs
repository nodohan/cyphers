<!DOCTYPE html>
<html lang="ko">

<head>
    <%- include ("../layout/head") %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script type="text/javascript">
        var myChart;

        const config = {
            type: 'line',
            data: {
                datasets: [],
                labels: []
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + '위';
                                }
                                return label;
                            }
                        }
                    }
                },
                maintainAspectRatio: false, // 컨테이너 크기에 맞춤
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'yyyy-MM-dd',
                            displayFormats: {
                                day: 'MM-dd'
                            }
                        }
                    },
                    y: {
                        reverse: true,
                        min: 1,
                    }
                },
                elements: {
                    point: {
                        radius: 2,
                        hoverRadius: 4,
                        hitRadius: 20,
                        pointStyle: 'circle'
                    }
                }
            }
        };

        $(document).ready(function() {
            $("#mainMenu").removeClass("active");
            $("#userChart").addClass("active");

            myChart = new Chart($("#myChart"), config);

            $("input[name='season']").on("change", resetChart);
        });

        function resetChart() {
            myChart.data.datasets = [];
            myChart.data.labels = [];
        }

        function userRankSearch() {
            const $nickInput = $("#nickNames");
            const nickName = $nickInput.val().trim();

            if (!nickName) {
                alert("닉네임을 입력해주세요.");
                return;
            }

            const exists = myChart.data.datasets.some(ds => ds.label === nickName);
            if (exists) {
                alert("이미 추가된 사용자입니다.");
                $nickInput.val("");
                return;
            }

            $nickInput.val("");

            searchUserRank(nickName);
        }

        function searchUserRank(nickName) {
            const currentSeason = $("input[name='season']:checked").val();

            $.ajax({
                async: true,
                url: "/rankChart/userRank",
                data: {
                    'nickname': nickName,
                    'season': currentSeason,
                    'dayType': 'full'
                },
                success: function(data) {
                    if (data.resultCode == -1) {
                        alert(nickName + "님의 정보가 없습니다.");
                    } else {
                        drawRank(nickName, data);
                    }
                },
                error: function() {
                    alert(nickName + "님의 정보가 없습니다.");
                }
            }).done(function() {

            });
        }

        function drawRank(nickName, row) {
            const color = 'rgb(' + getRandomInt(0, 255) + ', ' + getRandomInt(0, 255) + ', ' + getRandomInt(0, 255) + ')';

            const dataset = {
                label: nickName,
                data: row,
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2
            };

            myChart.data.datasets.push(dataset);
            myChart.update();
        }
    </script>
</head>

<body class="body">
<%- include  ("../layout/menu") %>

<div id="main">
    <div class="top" style="height:90px">
        <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" name="season" id="season_2025U" value="2025U" checked/>
            <label class="form-check-label" for="season_2025U"> 2025U (현재)</label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2025H" value="2025H" />
            <label class="form-check-label" for="season_2025H"> 2025H</label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2024U" value="2024U"/>
            <label class="form-check-label" for="season_2024U"> 2024U</label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2024H" value="2024H" />
            <label class="form-check-label" for="season_2024H"> 2024H</label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2023U" value="2023U" />
            <label class="form-check-label" for="season_2023U"> 2023U</label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2023H" value="2023H" />
            <label class="form-check-label" for="season_2023H"> 2023H </label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2022U" value="2022U" />
            <label class="form-check-label" for="season_2022U"> 2022U </label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2022H" value="2022H" />
            <label class="form-check-label" for="season_2022H"> 2022H </label>&nbsp;&nbsp;&nbsp;
            <input type="radio" class="form-check-input" name="season" id="season_2021U" value="2021U" />
            <label class="form-check-label" for="season_2021U"> 2021U </label>
        </div>
        <div style="margin-top: 10px;">
            <input type="text" class="shortText" id="nickNames" onKeyPress="if(event.keyCode == 13) { userRankSearch(); } " placeholder="닉네임" />
            <input type="button" value="검색" onClick="userRankSearch();">
            <input type="button" value="초기화" onClick="resetChart();">
        </div>


    </div>
    <div id="con1" class="con" style="width:87%">
        <h3>랭킹추이</h3>
        <div id="con1_2" class="table-responsive">
            <canvas id="myChart" width="900" height="400"></canvas>
        </div>

    </div>

    <!-- 카카오 광고 -->
    <%- include  ("../layout/rightBanner") %>
</div>

</body>

</html>