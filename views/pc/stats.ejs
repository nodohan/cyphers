<!DOCTYPE html>
<html lang="ko">

<head>
    <%- include  ("../layout/head") %>
    <script src="/js/charImage.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var myChart;

        $(document).ready(function() {
            $("#searchCharName").on("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault(); // form submit 방지 (필요하면)
                    searchChar();
                }
            });

            $("#sortByWinrate").on("click", toggleCharRate);
            $("#sortByTotalMatches").on("click", toggleTotalMatches);

            setDatePicker();
            $('#fromDt').on("change", callCharStats);
            $("#mainMenu").removeClass("active");
            getStats("statsCountList", drawCount);
            getStats("statsList", drawStatsList);
            callCharStats();
        });

        const callCharStats = () => {
            const day = $("#fromDt").val();
            getStats(`statsCharList?date=${day}`, drawCharFunc);
        }

        const setDatePicker = () => {
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            var yesterdayStr = yesterday.toISOString().slice(0, 10);

            $('#fromDt').datepicker({
                uiLibrary: 'bootstrap5',
                iconsLibrary: 'fontawesome',
                locale: 'kr-ko',
                minDate: '2025-09-25',
                value: yesterdayStr,
                format: 'yyyy-mm-dd',
                maxDate: yesterday
            });

        }


        const getYesterday = () => {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            const yyyy = yesterday.getFullYear();
            const mm = String(yesterday.getMonth() + 1).padStart(2, '0');
            const dd = String(yesterday.getDate()).padStart(2, '0');

            return `${yyyy}-${mm}-${dd}`;
        }

        let charData = [];
        let sortBy = "rate";
        let isRateDesc = true;
        let isTotalMatchesDesc = true;

        const initCharState = () => {
            charData = [];
            sortBy = "rate";
            isRateDesc = true;
            isTotalMatchesDesc = true;
        };

        const drawCharFunc = (data) => {
            charData = data.row;

            let list = [...charData];

            if (sortBy === "rate") {
                list.sort(isRateDesc ? rateDesc : rateAsc);
            } else if (sortBy === "totalMatches") {
                list.sort(isTotalMatchesDesc ? totalMatchesDesc : totalMatchesAsc);
            }

            const div = $("#charRate");
            div.empty();

            let table = $(`<table id="charTemplate" class="table table-striped table-condensed">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">순위</th>
                                <th scope="col">캐릭터</th>
                                <th scope="col">판수</th>
                                <th scope="col">승</th>
                                <th scope="col">패</th>
                                <th scope="col">승률</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>`);

            let tbody = table.find("tbody");

            if (list.length === 0) {
                tbody.append("<tr><td colspan='6'>데이터가 없습니다.</td></tr>");
            } else {
                for (let idx in list) {
                    const { char_name, total_matches: total, win_count, lose_count, rate } = list[idx];
                    let number = ((sortBy === "rate" && !isRateDesc) || (sortBy === "totalMatches" && !isTotalMatchesDesc))
                        ? list.length - Number(idx)
                        : Number(idx) + 1;

                    let tr = `<tr>
                                <td>${number}</td>
                                <td><img data-item='${char_name}' src='https://img-api.neople.co.kr/cy/characters/${charMap.get(char_name)}' alt="${char_name}"></td>
                                <td>${total.toLocaleString()}</td>
                                <td>${win_count.toLocaleString()}</td>
                                <td>${lose_count.toLocaleString()}</td>
                                <td>${rate}%</td>
                              </tr>`;
                    tbody.append(tr);
                }
            }

            div.append(table);
            searchChar();
        }

        const toggleCharRate = () => {
            if (sortBy !== "rate") {
                isRateDesc = true;
            } else {
                isRateDesc = !isRateDesc;
            }

            sortBy = "rate";

            drawCharFunc({ row: charData });

            $("#sortByWinrate").removeClass("disabled").toggleClass("rotate");
            $("#sortByTotalMatches").addClass("disabled").removeClass("rotate");
        };

        const toggleTotalMatches = () => {
            if (sortBy !== "totalMatches") {
                isTotalMatchesDesc = true;
            } else {
                isTotalMatchesDesc = !isTotalMatchesDesc;
            }

            sortBy = "totalMatches";

            drawCharFunc({ row: charData });

            $("#sortByTotalMatches").removeClass("disabled").toggleClass("rotate");
            $("#sortByWinrate").addClass("disabled").removeClass("rotate");
        };


        const searchChar = () => {
            const keyword = $("#searchCharName").val().toLowerCase(); // 입력값 (소문자 처리)
            const rows = $("#charRate table tbody tr");

            rows.each(function () {
                const charName = $(this).find("td:eq(1) img").attr("data-item");
                if (charName.includes(keyword)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        };

        const drawCount = (data) => {
            let div = $("#statsCountDiv");
            div.empty();

            let table = "<table class='table table-bordered table-striped'>";
            let tr = "<thead><tr>";
            let tbody = "<tbody><tr>";
            let endTbody = "</tr></tbody></table>";

            let th = "";
            let td = "";
            let trCount = 1;
            let first = true;
            for (idx in data.row) {
                let item = data.row[idx];
                th += "<th>" + replaceEngToKo(item.dates) + "</th>";
                td += "<td>" + item.cnt.toLocaleString() + "</td>";
                if (trCount % 7 == 0) {
                    let newTable = table + tr + th + tbody + td + endTbody;
                    th = "";
                    td = "";
                    if (first) {
                        $("#statsCountDiv").append(newTable);
                        first = false;
                    } else {
                        $("#moreCountDiv").append(newTable);
                    }
                }
                trCount++;
            }

            // 한줄도 append 못한경우 (7일치 데이터가 없는경우.)
            if(first) {
                let newTable = table + tr + th + tbody + td + endTbody;
                $("#statsCountDiv").append(newTable);
            }
        }

        function replaceEngToKo(date) {
            return date
                .replace("Monday", "월")
                .replace("Tuesday", "화")
                .replace("Wednesday", "수")
                .replace("Thursday", "목")
                .replace("Friday", "금")
                .replace("Saturday", "토")
                .replace("Sunday", "일");
        }

        function drawStatsList(data) {

            let wList = dataFilter(data.row, "weekly", "탱커", "top");
            setStatsWDueDate("weekly", wList[0]);
            drawStatsListDiv("wBestTanker", wList);
            drawStatsListDiv("wWorstTanker", dataFilter(data.row, "weekly", "탱커", "bottom"));
            drawStatsListDiv("wBestAttack", dataFilter(data.row, "weekly", "딜러", "top"));
            drawStatsListDiv("wWorstAttack", dataFilter(data.row, "weekly", "딜러", "bottom"));

            let mList = dataFilter(data.row, "monthly", "탱커", "top");
            setStatsWDueDate("monthly", mList[0]);
            drawStatsListDiv("mBestTanker", mList);
            drawStatsListDiv("mWorstTanker", dataFilter(data.row, "monthly", "탱커", "bottom"));
            drawStatsListDiv("mBestAttack", dataFilter(data.row, "monthly", "딜러", "top"));
            drawStatsListDiv("mWorstAttack", dataFilter(data.row, "monthly", "딜러", "bottom"));
        }

        function dataFilter(row, statsType, combiType, order) {
            let list = row.filter(item => item.stats_type == statsType)
                .filter(item => item.role == combiType)
                .filter(item => item.rank_type == order)
                .sort(order == "top" ? winDesc : winAsc);
            return list;
        }

        const winDesc = (a, b) => {
            if (a.win_rate_percent < b.win_rate_percent) {
                return 1;
            }
            if (a.win_rate_percent > b.win_rate_percent) {
                return -1;
            }
            return 0;
        }

        const winAsc = (a, b) => {
            if (a.win_rate_percent > b.win_rate_percent) {
                return 1;
            }
            if (a.win_rate_percent < b.win_rate_percent) {
                return -1;
            }
            return 0;
        }

        function totalMatchesDesc(a, b) {
            if (a.total_matches < b.total_matches) {
                return 1;
            }
            if (a.total_matches > b.total_matches) {
                return -1;
            }
        }

        function totalMatchesAsc(a, b) {
            if (a.total_matches < b.total_matches) {
                return -1;
            }
            if (a.total_matches > b.total_matches) {
                return 1;
            }
        }

        function setStatsWDueDate(type, item) {
            if (item == null) {
                return;
            }

            let span = (type == "weekly") ? $("#wDueSpan") : $("#mDueSpan");
            span.empty();
            span.append(item.statsFromDate + "~" + item.statsToDate);
        }

        function drawStatsListDiv(divId, data) {
            var table = $("#matchInfoTemplate").clone();
            table.removeAttr("id");
            let tbody = table.find("tbody");

            if (data.length == 0) {
                let tr = "<tr><td colspan='5'>데이터가 없습니다.</td></tr>";
                tbody.append(tr);
            }

            let idx = 0;
            for (idx in data) {
                if (idx >= 5) {
                    break;
                }
                const { char_combo: combi, total_matches: total, win_count, win_rate_percent: rate } = data[idx];
                let tr = `<tr>
                        <td>${getChars(combi.split(","))}</td>
                        <td>${total}</td>
                        <td>${win_count}</td>
                        <td>${total - win_count}</td>
                        <td>${rate}%</td>`;
                tbody.append(tr);
            }

            $("#" + divId).append(table);
        }

        function getChars(arr) {
            let images = "";
            if (arr == "") {
                return "<span style='font-size:32px;'>탱커 없음</span>";
            }
            for (idx in arr) {
                images += "&nbsp;&nbsp;&nbsp;<img data-item='" + arr[idx] + "' src='https://img-api.neople.co.kr/cy/characters/" + charMap.get(arr[idx]) + "'>"
            }
            return images;
        }

        function getStats(url, callback) {
            var result;
            $.ajax({
                async: true,
                url: "/stats/" + url,
                success: function(data) {
                    if (data.resultCode == -1) {
                        return;
                    }
                    callback(data);
                },
                error: function(data) {
                    return;
                }
            }).done(function() {

            });
            return result;
        }
    </script>
</head>

<body class="body renewalBody">
<%- include  ("../layout/menu") %>

<div id="statsMain" class="mainLayout">
    <!-- 카카오 광고 -->
    <%- include  ("../layout/rightBanner") %>
    <div class="playCounter">
        <h3>주간 공식 집계 판수 <i class="fas fa-angle-double-down" data-bs-toggle="collapse" data-bs-target="#moreCountDiv" aria-expanded="true"></i></h3>
        <div class="line"></div>
        <div id="statsCountDiv"></div>
        <div id="moreCountDiv" class="collapse"></div>
    </div>
    <div class="listWrapper">
        <article id="con1">
            <h3>최근 30일 조합</h3>
            <div class="line"></div>
            <section>
                <div class="bestCombi">
                    <h4>BEST 5</h4>
                    <div id="mBestTanker">
                        <h5>탱커</h5>
                    </div>
                    <div id="mBestAttack">
                        <h5>딜러</h5>
                    </div>
                </div>
                <div class="worstCombi">
                    <h4>WORST 5</h4>
                    <div id="mWorstTanker">
                        <h5>탱커</h5>
                    </div>
                    <div id="mWorstAttack">
                        <h5>딜러</h5>
                    </div>
                </div>
            </section>
        </article>
        <article id="con2">
            <h3>금주 조합</h3>
            <div class="line"></div>
            <section>
                <div class="bestCombi">
                    <h4>BEST 5</h4>
                    <div id="wBestTanker">
                        <h5>탱커</h5>
                    </div>
                    <div id="wBestAttack">
                        <h5>딜러</h5>
                    </div>
                </div>
                <div class="worstCombi">
                    <h4>WORST 5</h4>
                    <div id="wWorstTanker">
                        <h5>탱커</h5>
                    </div>
                    <div id="wWorstAttack">
                        <h5>딜러</h5>
                    </div>
                </div>
            </section>
        </article>
        <article id="con3">
            <div class="charSearchWrapper">
                <h3>캐릭터 승률</h3>
                <div class="charSearch">
                    <label for="searchCharName"><span class="searchIcon"></span></label>
                    <input type="text" id="searchCharName" placeholder="캐릭터명 검색" />
                </div>
            </div>
            <div class="line"></div>
            <section>
                <div class="season2025U">
                    <h4>2025U</h4>
                    <div class="charWinRate">
                        <h5>
                            <button type="button" id="sortByWinrate">승률순<span class="arrow"></span></button>
                            <button type="button" id="sortByTotalMatches" class="disabled">판수순<span class="arrow"></span></button>
                        </h5>
                    </div>
                    <div id="charRate">

                    </div>
                </div>
            </section>
        </article>
    </div>
</div>


<div style="display:none">
    <table id="matchInfoTemplate" class="table table-striped table-condensed">
        <thead class="thead-light">
        <tr>
            <th scope="col">조합</th>
            <th scope="col">판수</th>
            <th scope="col">승</th>
            <th scope="col">패</th>
            <th scope="col">승률</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


</body>

</html>